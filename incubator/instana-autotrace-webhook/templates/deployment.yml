apiVersion: apps/v1
kind: Deployment
metadata:
  name: instana-autotrace-webhook
  labels:
    {{- include "instana-autotrace-webhook.commonLabels" . | nindent 4 }}
    {{- if .Values.webhook.deployment.additionalLabels }}
    {{ toYaml .Values.webhook.deployment.additionalLabels | indent 4 }}
    {{- end }}
    {{- if .Values.webhook.deployment.additionalAnnotations }}
  annotations:
    {{ toYaml .Values.webhook.deployment.additionalAnnotations | indent 4 }}
    {{- end }}
spec:
  replicas: {{ .Values.webhook.deployment.replicas }}
  selector:
    matchLabels:
      app.kubernetes.io/instance: {{ .Release.Name }}
  strategy:
    type: RollingUpdate
  template:
    metadata:
      name: instana-autotrace-webhook
      labels:
        # Add required labels to match selector
        app.kubernetes.io/instance: {{ .Release.Name }}
        {{- include "instana-autotrace-webhook.commonLabels" . | nindent 8 }}
        {{- if .Values.webhook.pod.additionalLabels }}
        {{ toYaml .Values.webhook.pod.additionalLabels | indent 8 }}
        {{- end }}
        # Add checksum annotation from the certificate secret to trigger pod restart when certificates change
        {{- $tlsSecretName := include "instana-autotrace-webhook.tlsSecretName" . -}}
        {{- $certsSecret := lookup "v1" "Secret" .Release.Namespace $tlsSecretName }}
        {{- if $certsSecret }}
        # Use a shorter hash to stay within the 63 character limit for label values
        checksum/tls: "{{ (printf "%s%s"
          (index $certsSecret.data "tls.crt" | default "")
          (index $certsSecret.data "tls.key" | default "")) | sha256sum | trunc 63 }}"
        {{- else }}
        checksum/tls: "first-install"
        {{- end }}
    spec:
      terminationGracePeriodSeconds: 30
      serviceAccountName: {{ .Release.Name }}
{{- if and (hasKey .Values.webhook "priorityClass") (kindIs "map" .Values.webhook.priorityClass) (hasKey .Values.webhook.priorityClass "name") .Values.webhook.priorityClass.name }}
      priorityClassName: {{ .Values.webhook.priorityClass.name }}
{{- end }}
      securityContext:
{{- if .Values.webhook.pod.securityContext }}
{{ toYaml .Values.webhook.pod.securityContext | indent 8 }}
{{- end }}
{{- if (gt (len .Values.webhook.imagePullSecrets) 0) }}
      imagePullSecrets:
{{ toYaml .Values.webhook.imagePullSecrets | indent 8 }}
{{- else if (hasPrefix "containers.instana.io/" .Values.webhook.image) }}
      imagePullSecrets:
      - name: containers-instana-io
{{- end }}
      containers:
      - name: instana-autotrace-webhook
        image: {{ include "instana-autotrace-webhook.image" . }}
        imagePullPolicy: {{ .Values.webhook.imagePullPolicy }}
        securityContext:
          privileged: false
          allowPrivilegeEscalation: false
          capabilities:
            drop:
              - ALL
{{- if not .Values.openshift.enabled }}
          seccompProfile:
            type: RuntimeDefault
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          runAsUser: 1001
{{- end }}
        resources:
{{ toYaml .Values.webhook.pod.resources | indent 10 }}
        env:
        - name: WEBHOOK_POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: WEBHOOK_POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: SERVER_PORT
          value: {{ .Values.webhook.pod.port | quote }}
        - name: INSTANA_AUTOTRACE_WEBHOOK_VERSION
          value: {{ .Chart.AppVersion }}
        - name: INSTANA_AUTOTRACE_IGNORED_NAMESPACES
          value: {{ join "," (concat .Values.autotrace.exclude.builtin_namespaces .Values.autotrace.exclude.namespaces)}}
        - name: INSTANA_IGNORE
          value: "true"
{{- if .Values.autotrace.instrumentation.securityContext }}
        - name: INSTANA_INSTRUMENTATION_INIT_CONTAINER_SECURITY_CONTEXT
{{- if .Values.openshift.enabled }}
          value: {{ toJson (unset (.Values.autotrace.instrumentation.securityContext | default "{}") "runAsUser") | quote }}
{{- else }}
          value: {{ toJson .Values.autotrace.instrumentation.securityContext | default "{}" | quote }}
{{- end }}
{{- end }}
{{- if and (and .Values.autotrace.instrumentation.imagePullCredentials.registry .Values.autotrace.instrumentation.imagePullCredentials.username) .Values.autotrace.instrumentation.imagePullCredentials.password }}
        - name: INSTANA_INIT_PRIVATE_REGISTRY_ENABLED
          value: "true"
{{- end }}
        - name: INSTANA_INSTRUMENT_NODEJS
          value: {{ .Values.autotrace.instrumentation.manual.nodejs | quote }}
        - name: INSTANA_INSTRUMENT_NETCORE
          value: {{ .Values.autotrace.instrumentation.manual.netcore | quote }}
        - name: INSTANA_INSTRUMENT_NGINX
          value: {{ .Values.autotrace.instrumentation.manual.nginx | quote }}
        - name: INSTANA_INSTRUMENT_PYTHON
          value: {{ .Values.autotrace.instrumentation.manual.python | quote }}
        - name: INSTANA_INSTRUMENT_RUBY
          value: {{ .Values.autotrace.instrumentation.manual.ruby | quote }}
        - name: INSTANA_INSTRUMENTATION_INIT_CONTAINER_IMAGE
          value: {{ include "instrumentation.image" . }}
        - name: INSTANA_INSTRUMENTATION_INIT_CONTAINER_IMAGE_PULL_POLICY
          value: {{ .Values.autotrace.instrumentation.imagePullPolicy | quote }}
        - name: INSTANA_INSTRUMENTATION_INIT_CONTAINER_IMAGE_PULL_SECRET
          value: {{ .Values.autotrace.instrumentation.imagePullSecret | quote }}
        - name: INSTANA_AUTOTRACE_OPT_IN
          value: {{ .Values.autotrace.opt_in | quote }}
        - name: INSTANA_AUTOTRACE_NODEJS
          value: {{ .Values.autotrace.nodejs.enabled | quote }}
        - name: INSTANA_AUTOTRACE_NETCORE
          value: {{ .Values.autotrace.netcore.enabled | quote }}
        - name: INSTANA_AUTOTRACE_RUBY
          value: {{ .Values.autotrace.ruby.enabled | quote }}
        - name: INSTANA_AUTOTRACE_PYTHON
          value: {{ .Values.autotrace.python.enabled | quote }}
        - name: INSTANA_AUTOTRACE_ACE
          value: {{ .Values.autotrace.ace.enabled | quote }}
        - name: INSTANA_AUTOTRACE_IBMMQ
          value: {{ .Values.autotrace.ibmmq.enabled | quote }}
        - name: INSTANA_AUTOTRACE_NODEJS_ESM
          value: {{ .Values.autotrace.nodejs.esm | quote }}
        - name: INSTANA_AUTOTRACE_NODEJS_APPLICATION_TYPE
          value: {{ .Values.autotrace.nodejs.application_type | quote }}
        - name: INSTANA_AUTOTRACE_INGRESS_NGINX
          value: {{ .Values.autotrace.ingress_nginx.enabled | quote }}
        - name: INSTANA_AUTOTRACE_INGRESS_NGINX_STATUS
          value: {{ .Values.autotrace.ingress_nginx.status_enabled | quote }}
        - name: INSTANA_AUTOTRACE_INGRESS_NGINX_STATUS_ALLOW
          value: {{ .Values.autotrace.ingress_nginx.status_allow | quote }}
        - name: INSTANA_AUTOTRACE_USE_LIB_INSTANA_INIT
          value: {{ .Values.autotrace.libinstana_init.enabled | quote }}
{{- if and (hasKey .Values.autotrace "volume") (kindIs "map" .Values.autotrace.volume) (hasKey .Values.autotrace.volume "pvc") (kindIs "map" .Values.autotrace.volume.pvc) (hasKey .Values.autotrace.volume.pvc "name") .Values.autotrace.volume.pvc.name }}
        - name: INSTANA_USE_CUSTOM_VOLUME
          value: "true"
        - name: INSTANA_CUSTOM_VOLUME_PVC_NAME
          value: {{ .Values.autotrace.volume.pvc.name | quote }}
{{- end }}
        - name: INSTANA_AUTOTRACE_INIT_MEMORY_LIMIT
          value: {{ .Values.autotrace.initContainer.memoryLimit | quote }}
        - name: INSTANA_AUTOTRACE_INIT_CPU_LIMIT
          value: {{ .Values.autotrace.initContainer.cpuLimit | quote }}
        - name: INSTANA_AUTOTRACE_INIT_MEMORY_REQUEST
          value: {{ .Values.autotrace.initContainer.memoryRequest | quote }}
        - name: INSTANA_AUTOTRACE_INIT_CPU_REQUEST
          value: {{ .Values.autotrace.initContainer.cpuRequest | quote }}
{{- if .Values.awseksfargate.enabled }}
        - name: INSTANA_ENVIRONMENT_AWSEKSFARGATE
          value: "true"
        - name: INSTANA_AGENT_KEY
          value: {{ .Values.awseksfargate.instanaAgentKey | quote }}
        - name: INSTANA_ENDPOINT_URL
          value: {{ .Values.awseksfargate.instanaEndpointURL | quote }}
{{- end }}
        - name: LOGGING_LEVEL_ROOT
{{- if .Values.webhook.debug }}
          value: DEBUG
{{- else }}
          value: INFO
{{- end }}
{{- if .Values.webhook.netty.debug }}
        - name: LOGGING_LEVEL_IO_NETTY
          value: DEBUG
{{- end }}
{{- $javaToolOptions := ""  }}
{{- if .Values.webhook.ssl.insecure }}
  {{- $javaToolOptions = "-Dcom.sun.net.ssl.checkRevocation=false " }}
{{- end }}
{{- if .Values.webhook.debug }}
  {{- $javaToolOptions = (print $javaToolOptions "-Dcom.sun.net.ssl.checkRevocation=false ") }}
{{- end }}
{{- if .Values.webhook.remoteDebug }}
  {{- $javaToolOptions = (print $javaToolOptions "-Djavax.net.debug=ssl,handshake -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005 ") }}
{{- end }}
        - name: JAVA_TOOL_OPTIONS
          value: {{ $javaToolOptions }}
        volumeMounts:
          - name: certificates
            mountPath: /app/certs
            readOnly: true
        ports:
        - containerPort: {{ .Values.webhook.pod.port }}
{{- if .Values.webhook.remoteDebug }}
        - containerPort: 5005
{{- end }}
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: {{ .Values.webhook.pod.port }}
            scheme: HTTPS
          initialDelaySeconds: 5
          periodSeconds: 10
          timeoutSeconds: 2
          failureThreshold: 3
          successThreshold: 1
        startupProbe:
          httpGet:
            path: /actuator/health/readiness
            port: {{ .Values.webhook.pod.port }}
            scheme: HTTPS
          initialDelaySeconds: 5
          periodSeconds: 5
          timeoutSeconds: 2
          failureThreshold: 12
          successThreshold: 1
        livenessProbe:
          httpGet:
            path: /actuator/health/liveness
            port: {{ .Values.webhook.pod.port }}
            scheme: HTTPS
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 1
          failureThreshold: 3
{{- if .Values.webhook.pod.tolerations }}
      tolerations:
{{- toYaml .Values.webhook.tolerations | nindent 8 }}
{{- end }}
{{- if .Values.webhook.affinity }}
      affinity:
{{- toYaml .Values.webhook.affinity | nindent 8 }}
{{- end }}
      volumes:
        - name: certificates
          secret:
            secretName: {{ include "instana-autotrace-webhook.tlsSecretName" . }}
